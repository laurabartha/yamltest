<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="./style.css" rel="stylesheet" />
    <script src="goals.js"></script>
</head>
<body>
    <h1> Learning Goal Editor</h1>
    <button class="open"> Open </button>

    <section id="adventure-picker">
        <label for="adventure-select"> Choose adventure:</label>
        <select name="adventure" id="adventure-select">
            <option value="">--Please choose an option--</option>
        </select>
        <label for="level-select"> Choose level:</label>
        <select name="level" id="level-select">
            <option value="">--Please choose an option--</option>
        </select>
    </section>
    <section id="adventure-view">

    </section>
    <section id="editor" class="hidden">
      <button class="edit" id="edit"> Edit </button>
      <div class="learningGoals hidden">
        <label for="goal-select"> Choose Learning Goals:</label>
        <select name="goals" id="goal-select" multiple>
          <option value="">--Please choose an option--</option>
        </select>
        <button class="save">Save</button>
      </div>

    </section>

    <button class="close"> Save Changes To File</button>
    <script>
      let fileHandle;  
      let adventureList;
      let jsonContents;
      // populate learing goals
      const goalSelect = document.getElementById("goal-select");
      const learningGoalKeys = Object.keys(allLearningGoals);
      learningGoalKeys.forEach(key => {
        const newGoalOption = document.createElement("option", {value: key});
        const goalOptionText = document.createTextNode(key);
        newGoalOption.appendChild(goalOptionText);
        goalSelect.append(newGoalOption);
      });
      //   open button
      const open = document.querySelector(".open");
    
      open.addEventListener("click", async () => {
        // File opening starting here        
        [fileHandle] = await window.showOpenFilePicker();
        const file = await fileHandle.getFile();
        const contents = await file.text();
        jsonContents = await JSON.parse(contents);
    
        // end file opening         

        adventureList = Object.keys(jsonContents.adventures)

        
         const select = document.getElementById("adventure-select");
         adventureList.forEach((adventure, index) => {
            const newOption = document.createElement("option", {value: adventure});
            const optionText = document.createTextNode(adventure);
            newOption.appendChild(optionText);
            select.append(newOption)
        
         })
      })

      const resetLevelOptions = () => {
        const selectElement = document.getElementById("level-select");
        const defaultOption = document.createElement("option");
        const optionText = document.createTextNode("--Please choose an option--");
        defaultOption.appendChild(optionText);
        selectElement.replaceChildren(defaultOption);
      }

      const selectElement = document.getElementById("adventure-select");
      let levelOptions;
      selectElement.addEventListener("change", (event) => {
        const section = document.getElementById("adventure-view")
        section.replaceChildren();
        // make sure learning goal editor is hidden
        const editor = document.getElementById("editor");
        editor.classList.add("hidden");

        const error = document.createElement("p")    
        resetLevelOptions();
        
        if(!adventureList || !jsonContents){
         error.textContent = "Please open a file and try again"
         section.append(error);
        } else {
            const selectionKey = event.target.value; 
            const selection = jsonContents.adventures[selectionKey];
            console.log(selection.levels);
            
            levelOptions = selection.levels;
            const levelSelect = document.getElementById("level-select");
            Object.keys(levelOptions).forEach((level, index) => {
            const newOption = document.createElement("option", {value: level});
            const optionText = document.createTextNode(level);
            newOption.appendChild(optionText);
            levelSelect.append(newOption)
            })

           
        }
      })

      const selectLevel = document.getElementById("level-select");
      selectLevel.addEventListener("change", (event) => {
        const section = document.getElementById("adventure-view")
        section.replaceChildren();
        
        const error = document.createElement("p")    
       

        if(!adventureList || !jsonContents || !levelOptions){
          error.textContent = "Please open a file and try again"
          section.append(error);
        } else {
            const level = event.target.value;
            const levelData = levelOptions[level];

            const displayData = document.createElement("ul");

            Object.keys(levelData).forEach(property => {
                const displayProperty = document.createElement("li");
                displayProperty.textContent = `${property}: ${levelData[property]}`
                displayData.append(displayProperty);

            })

            section.append(displayData);

            const internals = document.querySelector(".learningGoals"); 
            internals.classList.add("hidden");
            const editor = document.getElementById("editor");
            editor.classList.remove("hidden"); 
      


            // add edit section, maybe edit button
            // edit button event handler, adds a select drop down, populated with 
            // learning goals, multiselect option should be available
            // save button and event handler for save button, should update jsonContents
            // and write to file as well
        }
            

      })

      const edit = document.getElementById("edit");
      edit.addEventListener("click", () => {
        const internals = document.querySelector(".learningGoals"); 
        internals.classList.remove("hidden");
      });

      const save = document.querySelector(".save")
      save.addEventListener("click", () => {
        const goals = document.getElementById("goal-select");
        const goalsToAdd = Array.from(goals.selectedOptions, (option) => option.value);

        jsonContents.adventures[selectElement.value].levels[selectLevel.value].learningGoals = goalsToAdd;
        console.log(jsonContents.adventures[selectElement.value].levels[selectLevel.value].learningGoals);
      })



    //   close button
    // const close = document.querySelector(".close");

    // close.addEventListener("click", () => { 
    //     const listOfInputs = document.getElementsByClassName("pokemon");

    //     let checkedList = []; 
    //     let ogListIndex = 0;
    //     console.log (listOfInputs);

    //     for(let card of listOfInputs) {
            

    //         const detailedCard = {
    //             name: cardList[ogListIndex].name,
    //             statusNormal: card.children[2].checked,
    //             statusReversed: card.children[4].checked
    //         }

        

    //         ogListIndex++; 
    //         checkedList.push(detailedCard)
    //     }

    //     // console.log(JSON.stringify(checkedList));
    //     saveFile(checkedList)

    // })

    // // Actual file saving happening here    



    </script>
</body>
</html>
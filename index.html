<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="./style.css" rel="stylesheet" />
    <script src="goals.js"></script>
</head>
<body>
    <h1> Learning Goal Viewer</h1>
    <button class="open"> Open </button>

    <section id="goal-picker">
        <label for="goal-select"> Choose goal:</label>
        <select name="goal" id="goal-select">
            <option value="">--Please choose an option--</option>
        </select>
    </section>

    <section id="adventure-view">

    </section>
    <section id="editor" class="hidden">
      <button class="edit" id="edit"> Edit </button>
      <div class="learningGoals hidden">
        <label for="goal-select"> Choose Learning Goals:</label>
        <select name="goals" id="goal-select" multiple>
          <option value="">--Please choose an option--</option>
        </select>
        <button class="save">Save</button>
      </div>

    </section>

    <button class="saveFile"> Save Changes To File</button>
    <script>
      let fileHandle;  
      let adventureList;
      let jsonContents;
      // populate learing goals
      const goalSelect = document.getElementById("goal-select");
      const learningGoalKeys = Object.keys(allLearningGoals);
      learningGoalKeys.forEach(key => {
        const newGoalOption = document.createElement("option", {value: key});
        const goalOptionText = document.createTextNode(key);
        newGoalOption.appendChild(goalOptionText);
        goalSelect.append(newGoalOption);
      });
      //   open button
      const open = document.querySelector(".open");
      // TODO: reset view on open to allow for opening another file
      open.addEventListener("click", async () => {
        // File opening starting here        
        [fileHandle] = await window.showOpenFilePicker();
        const file = await fileHandle.getFile();
        const contents = await file.text();
        jsonContents = await JSON.parse(contents);
    
        // end file opening         

        adventureList = Object.keys(jsonContents.adventures)

        
        //  const select = document.getElementById("adventure-select");
        //  adventureList.forEach((adventure, index) => {
        //     const newOption = document.createElement("option", {value: adventure});
        //     const optionText = document.createTextNode(adventure);
        //     newOption.appendChild(optionText);
        //     select.append(newOption)
        
        //  })
      })

      const resetLevelOptions = () => {
        // const selectElement = document.getElementById("level-select");
        // const defaultOption = document.createElement("option");
        // const optionText = document.createTextNode("--Please choose an option--");
        // defaultOption.appendChild(optionText);
        // selectElement.replaceChildren(defaultOption);
      }

      const selectGoal = document.getElementById("goal-select");
      // let levelOptions;
      selectGoal.addEventListener("change", (event) => {
        const section = document.getElementById("adventure-view")
        section.replaceChildren();
      

        const error = document.createElement("p")    
        resetLevelOptions();
        
        if(!adventureList || !jsonContents){
         error.textContent = "Please open a file and try again"
         section.append(error);
        } else {
            const selectedGoalKey = event.target.value; 
            adventureList.forEach((adventureKey)=>{
              let displayAdventure = false;
              const currentAdventureLevels = Object.values(jsonContents.adventures[adventureKey].levels)
              // funky option
              // const groupedLevels = Object.groupBy(currentAdventureLevels, (level) => { 
              //   if (!level.learning_goals) {
              //       return "No"
              //   };
              //   return level.learning_goals.includes(selectGoal.value) ? "yes" : "no"
              // })

              // if (groupedLevels.yes){
              //   console.log("Add stuff to html")
              // }

              // normal option. 
              let hasGoal = false;
              currentAdventureLevels.forEach((level) => {
                if (level.learning_goals && level.learning_goals.includes(selectGoal.value)) {
                  hasGoal = true;
                  console.log(level);
                }
              })

              if (hasGoal) {
                console.log("Add stuff to html");
              }
            });

           

              // 

            
            
            // levelOptions = selection.levels;
            // const levelSelect = document.getElementById("level-select");
            // Object.keys(levelOptions).forEach((level, index) => {
            // const newOption = document.createElement("option", {value: level});
            // const optionText = document.createTextNode(level);
            // newOption.appendChild(optionText);
            // levelSelect.append(newOption)
            // })

           
        }
      })

      // const selectLevel = document.getElementById("level-select");
      // selectLevel.addEventListener("change", (event) => {
      //   const section = document.getElementById("adventure-view")
      //   section.replaceChildren();
        
      //   const error = document.createElement("p")    
       

      //   if(!adventureList || !jsonContents || !levelOptions){
      //     error.textContent = "Please open a file and try again"
      //     section.append(error);
      //   } else {
      //       const level = event.target.value;
      //       const levelData = levelOptions[level];

      //       const displayData = document.createElement("ul");

      //       Object.keys(levelData).forEach(property => {
      //           const displayProperty = document.createElement("li");
      //           displayProperty.textContent = `${property}: ${levelData[property]}`
      //           displayData.append(displayProperty);

      //       })

      //       section.append(displayData);

      //       const internals = document.querySelector(".learningGoals"); 
      //       internals.classList.add("hidden");
      //       const editor = document.getElementById("editor");
      //       editor.classList.remove("hidden"); 
      
      //   }
            

      // })

      // const edit = document.getElementById("edit");
      // edit.addEventListener("click", () => {
      //   const internals = document.querySelector(".learningGoals"); 
      //   internals.classList.remove("hidden");
      // });

      // const save = document.querySelector(".save")
      // save.addEventListener("click", () => {
      //   const goals = document.getElementById("goal-select");
      //   const goalsToAdd = Array.from(goals.selectedOptions, (option) => option.value);
      
      //   jsonContents.adventures[selectElement.value].levels[selectLevel.value].learning_goals = goalsToAdd;
      //   // TODO: remove this log and add some sort of visual save confirmation indicator
      //   console.log(jsonContents.adventures[selectElement.value].levels[selectLevel.value].learning_goals);
      // })



      // //savefile button
      // const saveFile = document.querySelector(".saveFile");

      // saveFile.addEventListener("click", async () => { 
      //   const newHandle = await window.showSaveFilePicker();
      //   // create a FileSystemWritableFileStream to write to
      //   const writableStream = await newHandle.createWritable();
      //   // write our file
      //   await writableStream.write(JSON.stringify(jsonContents, null, 2));
      //   // close the file and write the contents to disk.
      //   await writableStream.close();
  
      // })

   



    </script>
</body>
</html>